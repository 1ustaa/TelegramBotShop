# Обновление: Вариации как отдельная таблица

## Описание изменений

Вариация товара теперь является отдельной таблицей в базе данных вместо простого текстового поля. Это позволяет пользователям выбирать вариацию из списка при заказе товара.

## Что изменилось

### 1. База данных
- **Создана новая таблица `variations`** с полями:
  - `id` (Integer, Primary Key)
  - `name` (String(200), Unique)
  
- **Изменена таблица `products`**:
  - Удалено поле `variation` (String)
  - Добавлено поле `variation_id` (Integer, Foreign Key -> variations.id)
  - Обновлен unique constraint для учета `variation_id` вместо `variation`

### 2. Порядок выбора товара
Теперь выбор вариации происходит **перед выбором цвета**:
1. Категория
2. Бренд аксессуара
3. Бренд устройства (если есть)
4. Модель устройства (если есть)
5. Серия (если есть)
6. **Вариация (если есть)** ← НОВОЕ
7. Цвет (если есть)
8. Выбор конкретного товара

### 3. Измененные файлы

#### data/model.py
- Добавлен класс `Variations`
- В классе `Products` поле `variation` заменено на `variation_id` с relationship

#### states/states.py
- Добавлено состояние `ChoseProduct.showing_variations`
- Добавлена логика проверки наличия вариаций
- Обновлены обработчики состояний

#### keyboards/builders.py
- Добавлена функция `variations_kb()` для создания клавиатуры выбора вариаций
- Обновлены функции `colors_kb()` и `products_kb()` для учета выбранной вариации

#### callbacks/callbacks.py
- Добавлены обработчики для выбора и пагинации вариаций
- Обновлены существующие обработчики для учета вариации

#### admin/views.py
- Добавлен `VariationsView` для управления вариациями в админ-панели
- Обновлен `ProductsView` для работы с новым полем
- Обновлена функция `import_from_excel()` для импорта вариаций

#### admin/app.py
- Зарегистрирован `VariationsView` в админ-панели

#### data/crud.py
- Обновлены функции `get_product_full_info()`, `get_cart_items()`, `get_order_details()` для загрузки вариаций

### 4. Миграция данных

Миграция `add_variations_table_202512.py` автоматически:
1. Создает таблицу `variations`
2. Извлекает уникальные значения из старого поля `variation`
3. Заполняет таблицу `variations` этими значениями
4. Добавляет поле `variation_id` в таблицу `products`
5. Мигрирует данные из `variation` в `variation_id`
6. Удаляет старое поле `variation`
7. Обновляет unique constraint

## Как использовать

### В админ-панели
1. Перейдите в раздел "Справочники" → "Вариации"
2. Добавьте/редактируйте вариации товаров
3. При создании продукта выберите вариацию из списка

### Импорт из Excel
Формат файла остался прежним:
- Колонка "Вариация" - текстовое значение
- При импорте автоматически создаются записи в таблице `variations`

### Для пользователей бота
- При выборе товара появится дополнительный шаг "Выберите вариацию"
- Шаг отображается только если у товаров есть вариации
- Выбор вариации происходит перед выбором цвета

## Откат изменений

Если нужно вернуться к старой версии:
```bash
alembic downgrade -1
```

Это вернет структуру БД к состоянию до миграции, восстановив текстовое поле `variation`.

